# Техническая документация

## Диалоговая система для анализа экономических новостей

### Структура проекта

```
economic_news_bot/
├── src/
│   ├── main.py                # Основной файл запуска системы
│   ├── news_parser.py         # Модуль парсинга новостей
│   ├── news_analyzer.py       # Модуль анализа новостей
│   ├── dialog_manager.py      # Модуль управления диалогом
│   ├── dialog_interface.py    # Модуль консольного интерфейса
│   └── config.json            # Файл конфигурации
├── tests/
│   ├── test_parser.py         # Тесты для модуля парсинга
│   ├── test_analyzer.py       # Тесты для модуля анализа
│   └── test_dialog.py         # Тесты для диалогового менеджера
├── cache/                     # Директория для кэширования данных
├── research_notes.md          # Исследовательские заметки
├── architecture.md            # Описание архитектуры системы
├── user_manual.md             # Руководство пользователя
└── todo.md                    # План разработки
```

### Описание модулей

#### 1. main.py

Основной файл системы, который инициализирует все компоненты и запускает диалоговый интерфейс.

**Основные классы и функции**:
- `EconomicNewsBot` - основной класс системы, который инициализирует и координирует работу всех компонентов
  - `__init__(config_path)` - инициализация системы с указанным файлом конфигурации
  - `_load_config(config_path)` - загрузка конфигурации из JSON-файла
  - `start()` - запуск диалоговой системы

#### 2. news_parser.py

Модуль для парсинга экономических новостей из различных источников.

**Основные классы и функции**:
- `NewsParser` - класс для парсинга новостей
  - `__init__(news_sources, cache_dir)` - инициализация парсера с указанными источниками и директорией кэша
  - `update_news()` - обновление новостей из всех источников
  - `_parse_rbc(url, source_name)` - парсинг новостей с сайта РБК
  - `_parse_ria(url, source_name)` - парсинг новостей с сайта РИА Новости
  - `get_latest_news(limit)` - получение последних новостей из кэша
  - `search_news(query, limit)` - поиск новостей по ключевому слову

#### 3. news_analyzer.py

Модуль для анализа экономических новостей с использованием языковой модели.

**Основные классы и функции**:
- `NewsAnalyzer` - класс для анализа новостей
  - `__init__(llm_api_config, cache_dir)` - инициализация анализатора с указанной конфигурацией API и директорией кэша
  - `analyze_news(news_item)` - анализ отдельной новости
  - `analyze_news_batch(news_items)` - анализ группы новостей
  - `summarize_news(news_items)` - создание сводки по группе новостей

#### 4. dialog_manager.py

Модуль для управления диалогом и обработки запросов пользователя.

**Основные классы и функции**:
- `DialogManager` - класс для управления диалогом
  - `__init__(news_analyzer, context_size)` - инициализация менеджера диалога с указанным анализатором и размером контекста
  - `add_to_context(message, role)` - добавление сообщения в контекст диалога
  - `get_context()` - получение текущего контекста диалога
  - `clear_context()` - очистка контекста диалога
  - `process_message(message, news_parser)` - обработка сообщения пользователя
  - `_determine_intent(message)` - определение намерения пользователя
  - `_extract_search_query(message)` - извлечение поискового запроса из сообщения
  - Обработчики различных типов запросов: `_handle_latest_news()`, `_handle_search_news()`, `_handle_analyze_news()`, `_handle_get_summary()`, `_handle_help()`, `_handle_greeting()`, `_handle_unknown()`

#### 5. dialog_interface.py

Модуль для консольного интерфейса диалоговой системы.

**Основные классы и функции**:
- `DialogInterface` - класс для консольного интерфейса
  - `__init__(dialog_manager)` - инициализация интерфейса с указанным менеджером диалога
  - `display_welcome()` - отображение приветственного сообщения
  - `display_message(message, message_type)` - отображение сообщения в консоли
  - `get_user_input()` - получение ввода пользователя
  - `run()` - запуск консольного интерфейса

### Алгоритмы и процессы

#### Процесс парсинга новостей

1. Система инициализирует парсер новостей с указанными источниками
2. Для каждого источника выполняется HTTP-запрос к соответствующему URL
3. HTML-страница анализируется с помощью BeautifulSoup для извлечения блоков с новостями
4. Из каждого блока извлекаются заголовок, ссылка, дата публикации и другие метаданные
5. Новости сохраняются в кэш для последующего использования

#### Процесс анализа новостей

1. Система инициализирует анализатор новостей с указанной конфигурацией API
2. Для каждой новости формируется запрос к языковой модели с инструкциями по анализу
3. Языковая модель возвращает результат анализа в формате JSON
4. Результат анализа сохраняется в кэш для последующего использования
5. При создании сводки система анализирует группу новостей и формирует общий отчет

#### Процесс обработки диалога

1. Пользователь вводит сообщение в консольный интерфейс
2. Сообщение передается в менеджер диалога для обработки
3. Менеджер диалога определяет намерение пользователя на основе ключевых слов и контекста
4. В зависимости от намерения вызывается соответствующий обработчик
5. Обработчик формирует ответ на основе данных из парсера и анализатора новостей
6. Ответ отображается пользователю через консольный интерфейс

### Взаимодействие с API языковой модели

Система использует API llm7.io для взаимодействия с языковой моделью gpt-4.1-nano. Взаимодействие осуществляется через библиотеку openai:

```python
# Инициализация клиента OpenAI
client = openai.OpenAI(
    base_url="https://api.llm7.io/v1",
    api_key="unused"
)

# Отправка запроса к языковой модели
response = client.chat.completions.create(
    model="gpt-4.1-nano",
    messages=[
        {"role": "system", "content": "Ты - аналитик экономических новостей."},
        {"role": "user", "content": prompt}
    ],
    temperature=0.3
)

# Получение ответа модели
result_text = response.choices[0].message.content
```

### Система кэширования

Для оптимизации производительности и снижения нагрузки на API система использует локальное кэширование:

1. **Кэш новостей** - сохраняет полученные новости в JSON-файл для последующего использования
2. **Кэш анализа** - сохраняет результаты анализа новостей для предотвращения повторных запросов к API

Кэш хранится в директории `cache/` и автоматически загружается при запуске системы.

### Обработка ошибок

Система включает механизмы обработки ошибок на различных уровнях:

1. **Ошибки парсинга** - при недоступности источника новостей система логирует ошибку и продолжает работу с другими источниками
2. **Ошибки API** - при проблемах с API языковой модели система возвращает заглушку с информацией об ошибке
3. **Ошибки ввода пользователя** - система обрабатывает неизвестные команды и предлагает пользователю справку

### Логирование

Система использует стандартный модуль logging для логирования событий:

```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("economic_bot.log"),
        logging.StreamHandler()
    ]
)
```

Логи содержат информацию о:
- Инициализации компонентов
- Получении и обновлении новостей
- Анализе новостей
- Обработке пользовательских запросов
- Ошибках и исключениях

### Тестирование

Система включает набор тестов для проверки работоспособности основных компонентов:

1. **test_parser.py** - тестирование модуля парсинга новостей
2. **test_analyzer.py** - тестирование модуля анализа новостей
3. **test_dialog.py** - тестирование диалогового менеджера и интеграции компонентов

Тесты можно запустить из директории `tests/` командой:
```bash
python test_parser.py
python test_analyzer.py
python test_dialog.py
```

### Расширение системы

Система спроектирована с учетом возможности расширения:

1. **Добавление новых источников новостей** - для добавления нового источника необходимо реализовать метод парсинга в классе `NewsParser`
2. **Расширение функциональности анализа** - можно добавить новые методы анализа в класс `NewsAnalyzer`
3. **Добавление новых типов запросов** - для поддержки новых типов запросов необходимо добавить соответствующие обработчики в класс `DialogManager`

### Требования к окружению

- Python 3.x
- Библиотеки: requests, beautifulsoup4, openai, rich
- Доступ к интернету для получения новостей и взаимодействия с API языковой модели

### Известные ограничения

1. Система работает только с текстовыми новостями, изображения и видео не обрабатываются
2. Анализ новостей зависит от доступности и качества API языковой модели
3. Парсинг новостей может перестать работать при изменении структуры сайтов-источников
